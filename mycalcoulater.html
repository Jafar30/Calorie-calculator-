<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حاسبة السعرات الحرارية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            direction: rtl; /* Ensure RTL for the entire body */
        }
        
        .input-field {
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .result-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #6366f1);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #6b7280, #4b5563);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 85, 99, 0.4);
        }
        
        .animate-bounce {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% {
                transform: translateY(-5px);
            }
            50% {
                transform: translateY(5px);
            }
        }

        /* Adjustments for RTL layout with Tailwind's flex/spacing */
        .space-x-reverse > *:not([dir="rtl"]) + *:not([dir="rtl"]) {
            margin-right: 1rem;
            margin-left: 0;
        }
        .space-x-reverse > *:not([dir="rtl"]) + *:not([dir="rtl"]) {
            margin-right: 1rem;
            margin-left: 0;
        }
        .flex.items-center .mr-2 { /* For icons with text */
            margin-right: 0;
            margin-left: 0.5rem;
        }
        .flex.items-center .ml-2 { /* For icons with text */
            margin-left: 0;
            margin-right: 0.5rem;
        }
        .text-right {
            text-align: right;
        }
        .text-left {
            text-align: left;
        }
        /* Specific adjustments for table headers and cells for RTL */
        #exchange-table th, #exchange-table td {
            text-align: center; /* Center align all table cells by default */
        }
        #exchange-table th:first-child, #exchange-table td:first-child {
            text-align: right; /* Align first column (category name) to the right */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-blue-600 mb-2">
                    <i class="fas fa-calculator ml-2"></i>حاسبة السعرات الحرارية
                </h1>
                <p class="text-gray-600">احسب احتياجاتك اليومية من السعرات الحرارية بناءً على معادلة هاريس بينديكت</p>
            </div>
            
            <!-- Calculator Form -->
            <div id="calculator-form" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">
                    <i class="fas fa-user-edit ml-2 text-blue-500"></i>المعلومات الشخصية
                </h2>
                
                <form id="calorie-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Name -->
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">الاسم</label>
                            <input type="text" id="name" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل اسمك">
                        </div>
                        
                        <!-- Age -->
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700 mb-1">العمر (سنوات)</label>
                            <input type="number" id="age" min="10" max="120" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل عمرك">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Gender -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">الجنس</label>
                            <div class="flex space-x-4 space-x-reverse">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="gender" value="male" checked class="form-radio text-blue-600">
                                    <span class="mr-2">ذكر</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="gender" value="female" class="form-radio text-pink-600">
                                    <span class="mr-2">أنثى</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Weight -->
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">الوزن (كغم)</label>
                            <input type="number" id="weight" min="30" max="300" step="0.1" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل وزنك">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- Height -->
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-700 mb-1">الطول (سم)</label>
                            <input type="number" id="height" min="100" max="250" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل طولك">
                        </div>
                        
                        <!-- Activity Level -->
                        <div>
                            <label for="activity" class="block text-sm font-medium text-gray-700 mb-1">مستوى النشاط</label>
                            <select id="activity" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200">
                                <option value="1.2">قليل النشاط جداً (لا تمارين)</option>
                                <option value="1.375">قليل النشاط (تمارين خفيفة 1-3 أيام/أسبوع)</option>
                                <option value="1.55" selected>متوسط النشاط (تمارين معتدلة 3-5 أيام/أسبوع)</option>
                                <option value="1.725">نشيط جداً (تمارين شاقة 6-7 أيام/أسبوع)</option>
                                <option value="1.9">نشيط للغاية (تمارين شاقة يومياً أو عمل بدني)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button type="submit" id="calculate-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center">
                            <i class="fas fa-calculator ml-2"></i> احسب السعرات
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Food Grams Calculator -->
            <div id="food-grams-calculator" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">
                    <i class="fas fa-utensils ml-2 text-blue-500"></i>حاسبة غرامات الطعام
                </h2>
                
                <form id="grams-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Meal Name -->
                        <div>
                            <label for="meal-name" class="block text-sm font-medium text-gray-700 mb-1">اسم الوجبة</label>
                            <input type="text" id="meal-name" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل اسم الوجبة">
                        </div>
                        
                        <!-- Original Grams -->
                        <div>
                            <label for="original-grams" class="block text-sm font-medium text-gray-700 mb-1">عدد الغرامات الأصلية</label>
                            <input type="number" id="original-grams" min="1" step="0.1" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل عدد الغرامات">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Original Calories -->
                        <div>
                            <label for="original-calories" class="block text-sm font-medium text-gray-700 mb-1">السعرات الحرارية الأصلية</label>
                            <input type="number" id="original-calories" min="1" step="1" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل السعرات الحرارية">
                        </div>
                        
                        <!-- New Calories -->
                        <div>
                            <label for="new-calories" class="block text-sm font-medium text-gray-700 mb-1">السعرات الحرارية المستهدفة</label>
                            <input type="number" id="new-calories" min="1" step="1" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل السعرات المستهدفة">
                        </div>
                    </div>
                    
                    <div class="flex justify-center">
                        <button type="submit" id="calculate-grams-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center">
                            <i class="fas fa-calculator ml-2"></i> احسب الغرامات الجديدة
                        </button>
                    </div>
                </form>
                
                <!-- Results Display -->
                <div id="grams-result" class="hidden mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-800" id="grams-result-text"></p>
                </div>
            </div>

            <!-- Macronutrient Calculator -->
            <div id="macro-calculator" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">
                    <i class="fas fa-chart-pie ml-2 text-blue-500"></i>حاسبة المغذيات الكبرى
                </h2>
                
                <form id="macro-form">
                    <div class="mb-4">
                        <label for="total-calories-macro" class="block text-sm font-medium text-gray-700 mb-1">إجمالي السعرات الحرارية المستهدفة</label>
                        <input type="number" id="total-calories-macro" min="1" step="1" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل إجمالي السعرات الحرارية">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label for="carb-percent" class="block text-sm font-medium text-gray-700 mb-1">الكربوهيدرات (%)</label>
                            <input type="number" id="carb-percent" min="0" max="100" step="1" class="w-full px-4 py-2 border rounded-lg input-field text-center focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="مثال: 50">
                        </div>
                        <div>
                            <label for="protein-percent" class="block text-sm font-medium text-gray-700 mb-1">البروتين (%)</label>
                            <input type="number" id="protein-percent" min="0" max="100" step="1" class="w-full px-4 py-2 border rounded-lg input-field text-center focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="مثال: 30">
                        </div>
                        <div>
                            <label for="fat-percent" class="block text-sm font-medium text-gray-700 mb-1">الدهون (%)</label>
                            <input type="number" id="fat-percent" min="0" max="100" step="1" class="w-full px-4 py-2 border rounded-lg input-field text-center focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="مثال: 20">
                        </div>
                    </div>
                    <p id="percentage-sum-warning" class="text-red-600 text-sm mb-4 hidden">
                        <i class="fas fa-exclamation-triangle ml-1"></i> مجموع النسب يجب أن يكون 100%. المجموع الحالي: <span id="current-sum">0</span>%
                    </p>
                    
                    <div class="flex justify-center">
                        <button type="submit" id="calculate-macro-btn" class="btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center">
                            <i class="fas fa-calculator ml-2"></i> احسب المغذيات الكبرى
                        </button>
                    </div>
                </form>
                
                <!-- Macro Results Display -->
                <div id="macro-results" class="hidden mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-green-800 mb-2 font-semibold">توزيع المغذيات الكبرى:</p>
                    <ul class="list-disc list-inside text-green-800">
                        <li><span class="font-medium">الكربوهيدرات:</span> <span id="result-carbs-grams">0</span> غرام</li>
                        <li><span class="font-medium">البروتين:</span> <span id="result-protein-grams">0</span> غرام</li>
                        <li><span class="font-medium">الدهون:</span> <span id="result-fat-grams">0</span> غرام</li>
                    </ul>
                </div>
            </div>

            <!-- Food Exchange Table -->
            <div id="food-exchange-table" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">
                    <i class="fas fa-exchange-alt ml-2 text-blue-500"></i>جدول تبادل الأغذية
                </h2>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse" id="exchange-table">
                        <thead class="bg-blue-600 text-white">
                            <tr>
                                <th class="p-3 border text-right font-semibold">فئة الغذاء</th>
                                <th class="p-3 border font-semibold">عدد الحصص (يومياً)</th>
                                <th class="p-3 border font-semibold">كربوهيدرات (جم)</th>
                                <th class="p-3 border font-semibold">دهون (جم)</th>
                                <th class="p-3 border font-semibold">بروتين (جم)</th>
                                <th class="p-3 border font-semibold">سعرات حرارية (كيلو كالوري)</th>
                                <th class="p-3 border font-semibold">إفطار (B)</th>
                                <th class="p-3 border font-semibold">وجبة خفيفة 1 (S1)</th>
                                <th class="p-3 border font-semibold">غداء (L)</th>
                                <th class="p-3 border font-semibold">وجبة خفيفة 2 (S2)</th>
                                <th class="p-3 border font-semibold">عشاء (D)</th>
                                <th class="p-3 border font-semibold">وجبة خفيفة 3 (S3)</th>
                            </tr>
                        </thead>
                        <tbody id="exchange-table-body">
                            <!-- Rows will be added dynamically by JavaScript -->
                        </tbody>
                        <tfoot class="bg-gray-800 text-white font-semibold">
                            <tr>
                                <td class="p-2 border">الإجمالي</td>
                                <td class="p-2 border" id="total-servings">0</td>
                                <td class="p-2 border" id="total-carbs">0</td>
                                <td class="p-2 border" id="total-fats">0</td>
                                <td class="p-2 border" id="total-proteins">0</td>
                                <td class="p-2 border" id="total-calories">0</td>
                                <td class="p-2 border" id="total-breakfast">0</td>
                                <td class="p-2 border" id="total-snack1">0</td>
                                <td class="p-2 border" id="total-lunch">0</td>
                                <td class="p-2 border" id="total-snack2">0</td>
                                <td class="p-2 border" id="total-dinner">0</td>
                                <td class="p-2 border" id="total-snack3">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Results Section (Initially Hidden) -->
            <div id="results-section" class="hidden">
                <div class="result-card rounded-lg p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">
                        <i class="fas fa-chart-line ml-2 text-blue-500"></i>نتائج الحساب
                    </h2>
                    
                    <div class="mb-6">
                        <p class="text-gray-700 mb-2">مرحباً <span id="result-name" class="font-semibold text-blue-600"></span>،</p>
                        <p class="text-gray-700">بناءً على المعلومات التي قدمتها، إليك نتائج حساب السعرات الحرارية:</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- BMR -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center mb-2">
                                <div class="bg-blue-100 p-2 rounded-full ml-3">
                                    <i class="fas fa-fire text-blue-600"></i>
                                </div>
                                <h3 class="font-medium text-gray-800">معدل الأيض الأساسي (BMR)</h3>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">السعرات الحرارية التي يحتاجها جسمك في حالة الراحة التامة</p>
                            <p class="text-2xl font-bold text-blue-600"><span id="bmr-result">0</span> سعرة حرارية</p>
                        </div>
                        
                        <!-- TDEE -->
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex items-center mb-2">
                                <div class="bg-green-100 p-2 rounded-full ml-3">
                                    <i class="fas fa-running text-green-600"></i>
                                </div>
                                <h3 class="font-medium text-gray-800">إجمالي الإنفاق اليومي (TDEE)</h3>
                            </div>
                            <p class="text-gray-600 text-sm mb-2">السعرات الحرارية للحفاظ على الوزن الحالي</p>
                            <p class="text-2xl font-bold text-green-600"><span id="tdee-result">0</span> سعرة حرارية</p>
                        </div>
                    </div>
                    
                    <!-- Goal Setting -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <h3 class="font-medium text-gray-800 mb-3">
                            <i class="fas fa-bullseye ml-2 text-purple-500"></i>تحديد الهدف
                        </h3>
                        
                        <div class="mb-4">
                            <label for="calorie-adjustment" class="block text-sm font-medium text-gray-700 mb-1">مقدار الزيادة أو النقصان في السعرات</label>
                            <div class="flex items-center">
                                <input type="number" id="calorie-adjustment" class="w-full px-4 py-2 border rounded-lg input-field focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="أدخل القيمة (مثل -500 لفقدان الوزن)">
                                <span class="ml-2 text-sm text-gray-500">سعرة حرارية/يوم</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">أدخل قيمة موجبة لزيادة الوزن أو قيمة سالبة لخسارة الوزن</p>
                        </div>
                        
                        <button id="update-goal-btn" class="btn-secondary text-white px-4 py-2 rounded-lg font-medium text-sm flex items-center">
                            <i class="fas fa-sync-alt ml-2"></i> تحديث الهدف
                        </button>
                    </div>
                    
                    <!-- Final Goal -->
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 rounded-lg text-white">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-bold text-lg">
                                <i class="fas fa-trophy ml-2"></i>هدفك اليومي من السعرات
                            </h3>
                            <div class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-bold">
                                <span id="goal-type">الحفاظ على الوزن</span>
                            </div>
                        </div>
                        <p class="text-3xl font-bold mb-2 text-center animate-bounce"><span id="final-goal">0</span> سعرة حرارية</p>
                        <p class="text-sm opacity-90" id="goal-description">هذه السعرات الحرارية الموصى بها يومياً للحفاظ على وزنك الحالي</p>
                    </div>
                </div>
                
                <div class="flex justify-center mt-8">
                    <button id="reset-btn" class="btn-secondary text-white px-6 py-3 rounded-lg font-medium flex items-center">
                        <i class="fas fa-redo ml-2"></i> إعادة الحساب
                    </button>
                </div>
            </div>

        </div>
    </div>
    
    <script>
        // Food Exchange Data: Defines nutritional values per serving for various food categories.
        // These values are used to calculate total macros and calories based on servings.
        const foodExchangeData = {
            'نشويات': { carbs: 15, fats: 1, proteins: 3, calories: 80 },
            'خضروات': { carbs: 5, fats: 0, proteins: 2, calories: 25 },
            'فواكه': { carbs: 15, fats: 0, proteins: 0, calories: 60 },
            'حليب': { carbs: 15, fats: 5, proteins: 8, calories: 120 },
            'بقوليات': { carbs: 15, fats: 1, proteins: 7, calories: 100 },
            'لحوم قليلة الدسم': { carbs: 0, fats: 3, proteins: 7, calories: 45 },
            'لحوم متوسطة الدسم': { carbs: 0, fats: 5, proteins: 7, calories: 75 },
            'لحوم عالية الدسم': { carbs: 0, fats: 8, proteins: 7, calories: 100 },
            'دهون': { carbs: 0, fats: 5, proteins: 0, calories: 45 }
        };

        // Macronutrient calorie values per gram
        const MACRO_CALORIES_PER_GRAM = {
            carbs: 4,
            protein: 4,
            fat: 9
        };

        // DOM Elements
        const calorieForm = document.getElementById('calorie-form');
        const gramsForm = document.getElementById('grams-form');
        const macroForm = document.getElementById('macro-form'); // New macro form
        const resultsSection = document.getElementById('results-section');
        const gramsResultDiv = document.getElementById('grams-result');
        const gramsResultText = document.getElementById('grams-result-text');
        const macroResultsDiv = document.getElementById('macro-results'); // New macro results div
        const exchangeTableBody = document.getElementById('exchange-table-body');
        const percentageSumWarning = document.getElementById('percentage-sum-warning');
        const currentSumSpan = document.getElementById('current-sum');

        let currentTDEE = 0; // To store the calculated TDEE for goal adjustment

        /**
         * Calculates the Basal Metabolic Rate (BMR) using the Harris-Benedict equation.
         * @param {string} gender - 'male' or 'female'.
         * @param {number} weight - Weight in kilograms.
         * @param {number} height - Height in centimeters.
         * @param {number} age - Age in years.
         * @returns {number} Calculated BMR.
         */
        function calculateBMR(gender, weight, height, age) {
            if (gender === 'male') {
                return 66 + (13.7 * weight) + (5 * height) - (6.8 * age);
            } else {
                return 655 + (9.6 * weight) + (1.8 * height) - (4.7 * age);
            }
        }

        /**
         * Handles the submission of the main calorie calculation form.
         * Calculates BMR and TDEE, then displays the results.
         * @param {Event} event - The form submission event.
         */
        function handleCalorieCalculation(event) {
            event.preventDefault(); // Prevent default form submission

            const name = document.getElementById('name').value.trim();
            const age = parseFloat(document.getElementById('age').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const activityFactor = parseFloat(document.getElementById('activity').value);
            const gender = document.querySelector('input[name="gender"]:checked').value;

            // Basic input validation
            if (!name || isNaN(age) || isNaN(weight) || isNaN(height) || age <= 0 || weight <= 0 || height <= 0) {
                alert('الرجاء إدخال جميع المعلومات المطلوبة بشكل صحيح.'); // Using alert for simplicity, consider a custom modal
                return;
            }

            const bmr = calculateBMR(gender, weight, height, age);
            const tdee = bmr * activityFactor;

            currentTDEE = tdee; // Store TDEE for goal adjustment

            document.getElementById('result-name').textContent = name;
            document.getElementById('bmr-result').textContent = bmr.toFixed(0);
            document.getElementById('tdee-result').textContent = tdee.toFixed(0);
            document.getElementById('final-goal').textContent = tdee.toFixed(0);
            document.getElementById('goal-type').textContent = 'الحفاظ على الوزن';
            document.getElementById('goal-description').textContent = 'هذه السعرات الحرارية الموصى بها يومياً للحفاظ على وزنك الحالي';

            resultsSection.classList.remove('hidden'); // Show results section
            resultsSection.scrollIntoView({ behavior: 'smooth' }); // Scroll to results
        }

        /**
         * Updates the daily calorie goal based on user adjustment.
         */
        function updateGoal() {
            const adjustment = parseFloat(document.getElementById('calorie-adjustment').value) || 0;
            const newGoal = currentTDEE + adjustment;

            document.getElementById('final-goal').textContent = newGoal.toFixed(0);

            if (adjustment > 0) {
                document.getElementById('goal-type').textContent = 'زيادة الوزن';
                document.getElementById('goal-description').textContent = `تستهدف ${newGoal.toFixed(0)} سعرة حرارية يومياً لزيادة الوزن.`;
            } else if (adjustment < 0) {
                document.getElementById('goal-type').textContent = 'خسارة الوزن';
                document.getElementById('goal-description').textContent = `تستهدف ${newGoal.toFixed(0)} سعرة حرارية يومياً لخسارة الوزن.`;
            } else {
                document.getElementById('goal-type').textContent = 'الحفاظ على الوزن';
                document.getElementById('goal-description').textContent = 'هذه السعرات الحرارية الموصى بها يومياً للحفاظ على وزنك الحالي';
            }
        }

        /**
         * Resets all calculator forms and hides results.
         */
        function resetCalculator() {
            calorieForm.reset();
            gramsForm.reset();
            macroForm.reset(); // Reset macro form
            resultsSection.classList.add('hidden');
            gramsResultDiv.classList.add('hidden');
            macroResultsDiv.classList.add('hidden'); // Hide macro results
            percentageSumWarning.classList.add('hidden'); // Hide warning
            document.getElementById('calorie-adjustment').value = ''; // Clear adjustment input
            
            // Reset food exchange table inputs
            document.querySelectorAll('.servings-input').forEach(input => input.value = '');
            document.querySelectorAll('.meal-input').forEach(input => input.value = '');
            updateFoodExchangeCalculations(); // Recalculate totals after resetting inputs
        }

        /**
         * Handles the calculation for converting food grams based on calories.
         * @param {Event} event - The form submission event.
         */
        function handleGramsCalculation(event) {
            event.preventDefault();

            const mealName = document.getElementById('meal-name').value.trim();
            const originalGrams = parseFloat(document.getElementById('original-grams').value);
            const originalCalories = parseFloat(document.getElementById('original-calories').value);
            const newCalories = parseFloat(document.getElementById('new-calories').value);

            if (!mealName || isNaN(originalGrams) || isNaN(originalCalories) || isNaN(newCalories) || originalGrams <= 0 || originalCalories <= 0 || newCalories <= 0) {
                alert('الرجاء إدخال جميع القيم الصحيحة لحاسبة الغرامات.'); // Using alert for simplicity
                return;
            }

            const newGrams = (originalGrams / originalCalories) * newCalories;
            gramsResultText.textContent = `للحصول على ${newCalories.toFixed(0)} سعرة حرارية من ${mealName}، تحتاج إلى ${newGrams.toFixed(1)} غرام.`;
            gramsResultDiv.classList.remove('hidden');
        }

        /**
         * Initializes the food exchange table by dynamically adding rows for each food category.
         * Attaches event listeners to the input fields within the table.
         */
        function initFoodExchangeTable() {
            exchangeTableBody.innerHTML = ''; // Clear existing rows
            
            Object.keys(foodExchangeData).forEach(category => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 even:bg-gray-50'; // Tailwind classes for styling
                row.setAttribute('data-category', category); // Custom attribute to easily identify category

                row.innerHTML = `
                    <td class="p-2 border font-medium text-right">${category}</td>
                    <td class="p-2 border">
                        <input type="number" min="0" step="0.1" 
                               class="w-full px-2 py-1 border rounded servings-input text-center" 
                               placeholder="0" value="">
                    </td>
                    <td class="p-2 border carbs-cell text-center">0</td>
                    <td class="p-2 border fats-cell text-center">0</td>
                    <td class="p-2 border proteins-cell text-center">0</td>
                    <td class="p-2 border calories-cell text-center">0</td>
                    <td class="p-2 border">
                        <input type="number" min="0" step="0.1" 
                               class="w-full px-2 py-1 border rounded meal-input text-center" 
                               data-meal="breakfast" placeholder="0" value="">
                    </td>
                    <td class="p-2 border">
                        <input type="number" min="0" step="0.1" 
                               class="w-full px-2 py-1 border rounded meal-input text-center" 
                               data-meal="snack1" placeholder="0" value="">
                    </td>
                    <td class="p-2 border">
                        <input type="number" min="0" step="0.1" 
                               class="w-full px-2 py-1 border rounded meal-input text-center" 
                               data-meal="lunch" placeholder="0" value="">
                    </td>
                    <td class="p-2 border">
                        <input type="number" min="0" step="0.1" 
                               class="w-full px-2 py-1 border rounded meal-input text-center" 
                               data-meal="snack2" placeholder="0" value="">
                    </td>
                    <td class="p-2 border">
                        <input type="number" min="0" step="0.1" 
                               class="w-full px-2 py-1 border rounded meal-input text-center" 
                               data-meal="dinner" placeholder="0" value="">
                    </td>
                    <td class="p-2 border">
                        <input type="number" min="0" step="0.1" 
                               class="w-full px-2 py-1 border rounded meal-input text-center" 
                               data-meal="snack3" placeholder="0" value="">
                    </td>
                `;
                exchangeTableBody.appendChild(row);
            });

            // Attach event listeners to all newly created input fields in the table
            document.querySelectorAll('.servings-input, .meal-input').forEach(input => {
                input.addEventListener('input', updateFoodExchangeCalculations);
            });

            updateFoodExchangeCalculations(); // Initial calculation after table is rendered
        }

        /**
         * Calculates and updates all totals in the food exchange table (macros, calories, and meal distribution).
         */
        function updateFoodExchangeCalculations() {
            let totalServings = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalProteins = 0;
            let totalCalories = 0;
            
            // Initialize meal totals
            const mealTotals = {
                breakfast: 0,
                snack1: 0,
                lunch: 0,
                snack2: 0,
                dinner: 0,
                snack3: 0
            };

            // Calculate values for each food category row
            document.querySelectorAll('#exchange-table-body tr').forEach(row => {
                const category = row.getAttribute('data-category');
                const servingsInput = row.querySelector('.servings-input');
                const servings = parseFloat(servingsInput.value) || 0;
                
                totalServings += servings; // Sum up total daily servings from the main servings input

                const nutrients = foodExchangeData[category];
                
                if (nutrients) {
                    // Calculate and update row-specific macro/calorie cells based on total daily servings
                    const carbs = (nutrients.carbs * servings);
                    const fats = (nutrients.fats * servings);
                    const proteins = (nutrients.proteins * servings);
                    const calories = (nutrients.calories * servings);
                    
                    row.querySelector('.carbs-cell').textContent = carbs.toFixed(1);
                    row.querySelector('.fats-cell').textContent = fats.toFixed(1);
                    row.querySelector('.proteins-cell').textContent = proteins.toFixed(1);
                    row.querySelector('.calories-cell').textContent = calories.toFixed(1);
                    
                    // Add to overall totals
                    totalCarbs += carbs;
                    totalFats += fats;
                    totalProteins += proteins;
                    totalCalories += calories;
                }

                // Sum up servings for each meal column across all categories
                Object.keys(mealTotals).forEach(mealKey => {
                    const mealInput = row.querySelector(`.meal-input[data-meal="${mealKey}"]`);
                    if (mealInput) {
                        mealTotals[mealKey] += parseFloat(mealInput.value) || 0;
                    }
                });
            });

            // Update totals row in the table footer
            document.getElementById('total-servings').textContent = totalServings.toFixed(1);
            document.getElementById('total-carbs').textContent = totalCarbs.toFixed(1);
            document.getElementById('total-fats').textContent = totalFats.toFixed(1);
            document.getElementById('total-proteins').textContent = totalProteins.toFixed(1);
            document.getElementById('total-calories').textContent = totalCalories.toFixed(1);
            
            document.getElementById('total-breakfast').textContent = mealTotals.breakfast.toFixed(1);
            document.getElementById('total-snack1').textContent = mealTotals.snack1.toFixed(1);
            document.getElementById('total-lunch').textContent = mealTotals.lunch.toFixed(1);
            document.getElementById('total-snack2').textContent = mealTotals.snack2.toFixed(1);
            document.getElementById('total-dinner').textContent = mealTotals.dinner.toFixed(1);
            document.getElementById('total-snack3').textContent = mealTotals.snack3.toFixed(1);
        }

        /**
         * Calculates macronutrient grams based on total calories and percentages.
         * @param {Event} event - The form submission event.
         */
        function handleMacroCalculation(event) {
            event.preventDefault();

            const totalCalories = parseFloat(document.getElementById('total-calories-macro').value);
            const carbPercent = parseFloat(document.getElementById('carb-percent').value);
            const proteinPercent = parseFloat(document.getElementById('protein-percent').value);
            const fatPercent = parseFloat(document.getElementById('fat-percent').value);

            // Input validation
            if (isNaN(totalCalories) || totalCalories <= 0 || 
                isNaN(carbPercent) || isNaN(proteinPercent) || isNaN(fatPercent) ||
                carbPercent < 0 || proteinPercent < 0 || fatPercent < 0) {
                alert('الرجاء إدخال قيم صحيحة لإجمالي السعرات ونسب المغذيات الكبرى.');
                return;
            }

            const totalPercentage = carbPercent + proteinPercent + fatPercent;
            if (totalPercentage !== 100) {
                percentageSumWarning.classList.remove('hidden');
                currentSumSpan.textContent = totalPercentage;
                macroResultsDiv.classList.add('hidden'); // Hide results if percentages don't sum to 100
                return;
            } else {
                percentageSumWarning.classList.add('hidden');
            }

            // Calculate calories for each macronutrient
            const carbCalories = (totalCalories * carbPercent) / 100;
            const proteinCalories = (totalCalories * proteinPercent) / 100;
            const fatCalories = (totalCalories * fatPercent) / 100;

            // Convert calories to grams
            const carbsGrams = carbCalories / MACRO_CALORIES_PER_GRAM.carbs;
            const proteinGrams = proteinCalories / MACRO_CALORIES_PER_GRAM.protein;
            const fatGrams = fatCalories / MACRO_CALORIES_PER_GRAM.fat;

            // Display results
            document.getElementById('result-carbs-grams').textContent = carbsGrams.toFixed(1);
            document.getElementById('result-protein-grams').textContent = proteinGrams.toFixed(1);
            document.getElementById('result-fat-grams').textContent = fatGrams.toFixed(1);
            macroResultsDiv.classList.remove('hidden');
        }

        // Event Listeners when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            initFoodExchangeTable(); // Initialize the food exchange table

            calorieForm.addEventListener('submit', handleCalorieCalculation);
            document.getElementById('update-goal-btn').addEventListener('click', updateGoal);
            document.getElementById('reset-btn').addEventListener('click', resetCalculator);
            gramsForm.addEventListener('submit', handleGramsCalculation);
            macroForm.addEventListener('submit', handleMacroCalculation); // New event listener for macro form

            // Add input event listeners for percentage fields to update sum warning
            document.getElementById('carb-percent').addEventListener('input', checkPercentageSum);
            document.getElementById('protein-percent').addEventListener('input', checkPercentageSum);
            document.getElementById('fat-percent').addEventListener('input', checkPercentageSum);
        });

        /**
         * Checks the sum of macronutrient percentages and displays a warning if not 100%.
         */
        function checkPercentageSum() {
            const carbPercent = parseFloat(document.getElementById('carb-percent').value) || 0;
            const proteinPercent = parseFloat(document.getElementById('protein-percent').value) || 0;
            const fatPercent = parseFloat(document.getElementById('fat-percent').value) || 0;
            const sum = carbPercent + proteinPercent + fatPercent;

            if (sum !== 100) {
                percentageSumWarning.classList.remove('hidden');
                currentSumSpan.textContent = sum;
            } else {
                percentageSumWarning.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
